#!/usr/bin/env node
const fs = require('fs');
const path = require('path');
const { getReport } = require('../lib/crypto-weekly');

// optional LLM support (reuse pattern from other scripts)
let fetchFn = null;
try{ fetchFn = require('node-fetch'); }catch(e){ fetchFn = null; }

async function generateNarrativeWithLLM(summary, movers){
  const apiKey = process.env.OPENAI_API_KEY;
  if(!apiKey) return null;
  const model = process.env.OPENAI_MODEL || 'gpt-5-mini';
  console.log('LLM model:', model);
  const prompt = `You are a concise market analyst. Given a two-line top-10 summary and arrays of top gainers/losers, produce a JSON object with keys: title (short page title), snapshot (1-2 short sentences), highlights (array up to 6 bullets), headlines (array up to 6 short headlines). Respond with valid JSON only.\n\nsummary: ${String(summary)}\n\nmovers: ${JSON.stringify(movers)}\n\nExample: {"title":"Crypto Weekly Preview: Top-10 snapshot","snapshot":"...","highlights":["..."],"headlines":["..."]}`;
  const url = 'https://api.openai.com/v1/chat/completions';
  const body = { model, messages:[{role:'system', content:'You are a professional financial market analyst. Be concise and factual.'},{role:'user', content:prompt}], max_tokens:300, temperature:0.6 };
  try{
    const res = await (fetchFn ? fetchFn(url, { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify(body) }) : fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify(body) }));
    if(!res || !res.ok){ console.warn('LLM request failed', res && res.status); return null; }
    const json = await res.json();
    const content = json && json.choices && json.choices[0] && (json.choices[0].message && json.choices[0].message.content || json.choices[0].text);
    if(!content) return null;
    const m = content.match(/\{[\s\S]*\}/m);
    const jtxt = m ? m[0] : content;
    try{ return JSON.parse(jtxt); }catch(e){ console.warn('Failed to parse LLM JSON response for preview'); return null; }
  }catch(e){ console.warn('LLM preview generation failed', e && e.message); return null; }
}

function buildHtml(title, snapshot, highlights, reports, generatedAt){
  const now = generatedAt || new Date().toISOString();
  return `<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>${title}</title>
  <link rel="stylesheet" href="/reports/report.css" />
</head>
<body>
  <div class="wrapper">
    <div class="title">
      <h1>${title}</h1>
      <div class="muted">Generated: ${now}</div>
    </div>

    <div class="card">
      <h2 class="snapshot-title">Snapshot</h2>
      <p class="muted">${snapshot}</p>
    </div>

    <div class="card">
      <h3 class="section-title">Highlights</h3>
      <ul class="clean">
        ${Array.isArray(highlights) ? highlights.map(h => `<li>${h}</li>`).join('\n') : ''}
      </ul>
    </div>

    <div class="card grid">
      <div>
        <h3 class="section-title">Top-10 movers</h3>
        <ul class="clean">
          ${reports.map(r => `<li><strong>${r.name} (${r.symbol})</strong>: ${r.priceSummary.split('\n')[1] || ''}</li>`).join('\n')}
        </ul>
      </div>

      <aside class="aside">
        <h3 class="section-title">Latest Headlines</h3>
        <ul class="clean">
          ${ (reports.slice(0,6).map((r,i)=>{ const ev = (r.data && r.data.events && r.data.events[0]) ? (r.data.events[0].title || r.data.events[0].headline || r.data.events[0].description || '') : ''; return `<li>${r.name}: ${ev}</li>` }).join('\n')) }
        </ul>
      </aside>
    </div>

    <div class="footer">Generated by Cointist  data from CoinGecko & Binance</div>
  </div>
</body>
</html>`;
}

async function main(){
  try{
    const report = await getReport();
    if(!report || !Array.isArray(report.reports)) throw new Error('No report data');
    const generatedAt = new Date().toISOString();

    // Try to get an LLM-enhanced preview title and highlights
    let previewMeta = null;
    try{
      previewMeta = await generateNarrativeWithLLM(report.summary, report.movers);
      if(previewMeta) console.log('LLM preview used');
      else console.log('LLM preview not available; using deterministic summary');
    }catch(e){ previewMeta = null; }

    const title = (previewMeta && previewMeta.title) ? previewMeta.title : `Crypto Weekly Preview â€” Top-10 snapshot`;
    const snapshot = (previewMeta && previewMeta.snapshot) ? previewMeta.snapshot : report.summary || '';
    const highlights = (previewMeta && Array.isArray(previewMeta.highlights) && previewMeta.highlights.length) ? previewMeta.highlights : (report.reports.slice(0,5).map(r => `${r.name}: ${r.signals && typeof r.signals.change === 'number' ? `${r.signals.change.toFixed(2)}%` : ''}`));
    const headlines = (previewMeta && Array.isArray(previewMeta.headlines) && previewMeta.headlines.length) ? previewMeta.headlines : (report.reports.slice(0,6).map(r => (r.data && r.data.events && r.data.events[0] && (r.data.events[0].title || r.data.events[0].headline || r.data.events[0].description)) || ''));

    const html = buildHtml(title, snapshot, highlights, report.reports, generatedAt);

    const latest = {
      generatedAt,
      title,
      snapshot,
      highlights,
      headlines,
      // include the full per-report `data` so the preview page can use snapshot/chronology/etc.
      reports: report.reports.map(r => ({
        id: r.id,
        name: r.name,
        symbol: r.symbol,
        priceSummary: r.priceSummary,
        signals: r.signals,
        metrics: r.metrics,
        // preserve any computed narrative pieces and events
        data: r.data || {},
        // keep top-level events for convenience too
        events: (r.data && r.data.events) ? r.data.events : (r.events || [])
      }))
    };

    const reportsDir = path.join(process.cwd(), 'public', 'reports');
    if(!fs.existsSync(reportsDir)) fs.mkdirSync(reportsDir, { recursive: true });
    const nowShort = new Date().toISOString().slice(0,10).replace(/-/g,'');
    const outFile = path.join(reportsDir, `crypto-weekly-preview-${nowShort}.html`);
    const latestJsonFile = path.join(reportsDir, `crypto-weekly-preview-latest.json`);
    const latestHtmlFile = path.join(reportsDir, `crypto-weekly-preview-latest.html`);

    fs.writeFileSync(outFile, html, 'utf8');
    fs.writeFileSync(latestJsonFile, JSON.stringify(latest, null, 2), 'utf8');
    fs.writeFileSync(latestHtmlFile, html, 'utf8');

    console.log('Wrote preview HTML to', outFile);
    console.log('Wrote latest JSON to', latestJsonFile);
    console.log('Wrote latest HTML to', latestHtmlFile);

  }catch(e){
    console.error('Preview generator failed', e && e.message);
    process.exit(1);
  }
}

main();
